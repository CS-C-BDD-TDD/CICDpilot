# This file is automatically generated by the Cyber Indicators application
#
# DO NOT MODIFY THIS FILE
#!/bin/bash
export JAVA_HOME=${JAVA_HOME:=/usr/java/cyber-indicators}
export HOSTNAME=${HOSTNAME:=`hostname`}
export KEYPASS=${KEYPASS:=changeit}
export KEYSTORE_PATH=${KEYSTORE_PATH:=/usr/share/tomcat7/keystore}
export LOG=/var/log/cyber-indicators.init.keystore
echo "Resetting self-signed certificates in keystore: $KEYSTORE_PATH"
echo "Logging to $LOG."

if [ ! -e "$KEYSTORE_PATH/cacerts" ]; then
  echo "Keystore does not exist."
  echo "[$D] Creating keystore $KEYSTORE_PATH/cacerts" >> $LOG
  echo "Creating keystore."
  mkdir -p $KEYSTORE_PATH
  printf "$KEYPASS\n$KEYPASS" | $JAVA_HOME/bin/keytool -genkey -alias default -keyalg RSA -dname "CN=$HOSTNAME,OU=default" -keystore $KEYSTORE_PATH/cacerts 2> $LOG
fi

export D=`date`
echo "[$D] Resetting keystore" >> $LOG
echo $KEYPASS | $JAVA_HOME/bin/keytool -delete -alias cyber-indicators -keystore $KEYSTORE_PATH/cacerts 2>> $LOG
echo $KEYPASS | $JAVA_HOME/bin/keytool -genkey -alias cyber-indicators -keyalg RSA -dname "CN=$HOSTNAME,OU=cyber-indicators" -keystore $KEYSTORE_PATH/cacerts 2> $LOG
echo $KEYPASS | $JAVA_HOME/bin/keytool -delete -alias search -keystore $KEYSTORE_PATH/cacerts 2> $LOG
echo $KEYPASS | $JAVA_HOME/bin/keytool -genkey -alias search -keyalg RSA -dname "CN=localhost,OU=cyber-indicators" -keystore $KEYSTORE_PATH/cacerts 2> $LOG
echo "Ignoring Alias does not exist keytool errors.  These are benign."
echo "done."
