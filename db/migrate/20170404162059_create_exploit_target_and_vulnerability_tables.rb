class CreateExploitTargetAndVulnerabilityTables < ActiveRecord::Migration
  def up

    if !ActiveRecord::Base.connection.table_exists?(:exploit_targets)
      create_table :exploit_targets do |t|
        t.string :stix_id
        t.string :portion_marking
        t.timestamps
        t.string :guid
        t.string :created_by_user_guid
        t.string :updated_by_user_guid
        t.string :created_by_organization_guid
        t.string :updated_by_organization_guid
        t.integer :acs_set_id
        t.datetime :stix_timestamp
        t.boolean :read_only, :default => false
      end
    end

    if !ActiveRecord::Base.connection.index_exists?(:exploit_targets, :guid)
      add_index :exploit_targets, :guid
    end
    
    if !ActiveRecord::Base.connection.index_exists?(:exploit_targets, :stix_id)
      add_index :exploit_targets, :stix_id
    end

    if !ActiveRecord::Base.connection.table_exists?(:vulnerabilities)
      create_table :vulnerabilities do |t|
      	t.string :title
        t.string :title_c
        t.text   :description
        t.string :description_c
        t.string :cve_id
        t.string :cve_id_c
        t.string :osvdb_id
        t.string :osvdb_id_c
        t.string :portion_marking
        t.timestamps
        t.string :guid
        t.string :created_by_user_guid
        t.string :updated_by_user_guid
        t.string :created_by_organization_guid
        t.string :updated_by_organization_guid
        t.datetime :stix_timestamp
        t.boolean :read_only, :default => false
      end
    end

    if !ActiveRecord::Base.connection.index_exists?(:vulnerabilities, :guid)
      add_index :vulnerabilities, :guid
    end

    if !ActiveRecord::Base.connection.table_exists?(:exploit_target_vulnerabilities)
      create_table :exploit_target_vulnerabilities do |t|
        t.string :stix_exploit_target_id
        t.string :vulnerability_guid
        t.timestamps
        t.string :guid
  	    t.string :user_guid
      end
    end

    if !ActiveRecord::Base.connection.index_exists?(:exploit_target_vulnerabilities, :stix_exploit_target_id)
      add_index :exploit_target_vulnerabilities, :stix_exploit_target_id
    end
    
    if !ActiveRecord::Base.connection.index_exists?(:exploit_target_vulnerabilities, :vulnerability_guid)
      add_index :exploit_target_vulnerabilities, :vulnerability_guid
    end
    
    if !ActiveRecord::Base.connection.index_exists?(:exploit_target_vulnerabilities, :guid)
      add_index :exploit_target_vulnerabilities, :guid
    end

    if !ActiveRecord::Base.connection.table_exists?(:exploit_target_coas)
      create_table :exploit_target_coas do |t|
        t.string :stix_exploit_target_id
        t.string :stix_course_of_action_id
        t.timestamps
        t.string :guid
  	    t.string :user_guid
      end
    end

    if !ActiveRecord::Base.connection.index_exists?(:exploit_target_coas, :stix_exploit_target_id)
      add_index :exploit_target_coas, :stix_exploit_target_id
    end

    if !ActiveRecord::Base.connection.index_exists?(:exploit_target_coas, :stix_course_of_action_id)
      add_index :exploit_target_coas, :stix_course_of_action_id
    end

    if !ActiveRecord::Base.connection.index_exists?(:exploit_target_coas, :guid)
      add_index :exploit_target_coas, :guid
    end

    if !ActiveRecord::Base.connection.table_exists?(:exploit_target_packages)
      create_table :exploit_target_packages do |t|
        t.string :stix_exploit_target_id
        t.string :stix_package_id
        t.timestamps
        t.string :guid
  	    t.string :user_guid
      end
    end

    if !ActiveRecord::Base.connection.index_exists?(:exploit_target_packages, :stix_exploit_target_id)
      add_index :exploit_target_packages, :stix_exploit_target_id
    end
    
    if !ActiveRecord::Base.connection.index_exists?(:exploit_target_packages, :stix_package_id)
      add_index :exploit_target_packages, :stix_package_id
    end
    
    if !ActiveRecord::Base.connection.index_exists?(:exploit_target_packages, :guid)
      add_index :exploit_target_packages, :guid
    end
    
  end

  def down
    remove_index :exploit_targets, :guid
    remove_index :exploit_targets, :stix_id

    remove_index :vulnerabilities, :guid

    remove_index :exploit_target_vulnerabilities, :stix_exploit_target_id
    remove_index :exploit_target_vulnerabilities, :vulnerability_guid
    remove_index :exploit_target_vulnerabilities, :guid

    # needed to specify the name because index names were too long max 62 char
    remove_index :exploit_target_coas, :stix_exploit_target_id
    remove_index :exploit_target_coas, :stix_course_of_action_id
    remove_index :exploit_target_coas, :guid

    remove_index :exploit_target_packages, :stix_exploit_target_id
    remove_index :exploit_target_packages, :stix_package_id
    remove_index :exploit_target_packages, :guid

    drop_table :exploit_targets
    drop_table :vulnerabilities
    drop_table :exploit_target_vulnerabilities
    drop_table :exploit_target_coas
    drop_table :exploit_target_package
  end
end
