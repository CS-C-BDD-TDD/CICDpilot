app.controller('ExploitTargetsNewController',['$scope','$location','$rootScope','Restangular', 'bulkActionsService', 'exploitTargetService', 
  function($scope,$location,$rootScope,Restangular,bulkActionsService, exploitTargetService) {
    $rootScope.breadcrumbs = [{text:'Home',link:'#/',icon:'fa-home'},
                              {text:'All Exploit Targets',link:'#/exploit_targets',icon:'fa-list'},
                              {text:'New',link:'#/exploit_targets/new',icon:'fa-plus'}];
    $scope.exploit_target = exploitTargetService.get_data() || {};
    $scope.exploit_target.stix_packages = bulkActionsService.get() || $scope.exploit_target.stix_packages || [];
    $scope.exploit_target.course_of_actions = $scope.exploit_target.course_of_actions || [];
    $scope.exploit_target.vulnerabilities = $scope.exploit_target.vulnerabilities || [];
    $scope.save = function(exploit_target, done){
      var package_ids=_.map(exploit_target.stix_packages,function(i) {
        return i.stix_id;
      });
      var coa_ids=_.map(exploit_target.course_of_actions,function(i) {
        return i.stix_id;
      });
      
      var vulnerability_ids=_.map(exploit_target.vulnerabilities,function(i) {
        return i.guid;
      });
      
      exploit_target.stix_package_stix_ids=package_ids;
      
      exploit_target.course_of_action_stix_ids = coa_ids;
      exploit_target.vulnerability_guids = vulnerability_ids;
      
      Restangular.all('exploit_targets').post(exploit_target).then(function(data){
        toastr.success("New exploit target created");
        $scope.exploit_target = data;
        $location.path('/exploit_targets/'+encodeURIComponent($scope.exploit_target.stix_id));
      },function(res){
        toastr.error("Unable to save Exploit Target");
        $rootScope.show_res_errors(res);
        $scope.exploit_target.errors = res.data.errors;
      });
      done();
    };
  }
]);
