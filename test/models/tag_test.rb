require 'test_helper'

class TagTest < ActiveSupport::TestCase
  def setup
    setup_api_user
  end

  test "two tags with the same name, with different owners are valid" do
    UserTag.create name:'tag',user_guid:1
    tag = UserTag.new name:'tag',user_guid:2
    assert tag.valid?,'two tags can exist with the same name with different owners'
  end

  test "duplicate tags with the same owner are invalid" do
    UserTag.create name:'tag',user_guid: 1
    tag = UserTag.new name:'tag',user_guid: 1
    assert tag.invalid?,'duplicate tags with the same owner are invalid'
  end

  test "tags with no owner are valid" do
    tag = UserTag.new name:'tag'
    assert tag.valid?,'tags with no owner are valid'
  end

  test "can retrieve with a normalized name" do
    SystemTag.create! name:'FooBar12'
    assert((SystemTag.where(name_normalized: 'foobar12').count == 1), 'tags can be retrieved with a normalized name')
  end

  test "pmap" do
    t = SystemTag.create! name: 'FO01'
    i1 = Indicator.create!(title:"A",description:"a",indicator_type:"Benign")
    a1 = Address.create!(address_input:'1.2.3.4')
    o1 = Observable.create!(indicator: i1, object: a1)
    i2 = Indicator.create!(title:"B",description:"B",indicator_type:"Benign")
    a2 = Address.create!(address_input:'10.2.15.0/24')
    o2 = Observable.create!(indicator: i2, object: a2)
    i1.system_tags << t
    i2.system_tags << t
    assert(t.to_pmap == "1.2.3.4/32\tno reason given\n10.2.15.0/24\tno reason given\n", 'pmap format should match')
  end

  test "ipset" do
    t = SystemTag.create! name: 'FO01'
    i1 = Indicator.create!(title:"A",description:"a",indicator_type:"Benign")
    a1 = Address.create!(address_input:'1.2.3.4')
    o1 = Observable.create!(indicator: i1, object: a1)
    i2 = Indicator.create!(title:"B",description:"B",indicator_type:"Benign")
    a2 = Address.create!(address_input:'10.2.15.0/24')
    o2 = Observable.create!(indicator: i2, object: a2)
    i1.system_tags << t
    i2.system_tags << t
    assert(t.to_ipset == "1.2.3.4/32\n10.2.15.1/32\n10.2.15.2/32\n10.2.15.3/32\n10.2.15.4/32\n10.2.15.5/32\n10.2.15.6/32\n10.2.15.7/32\n10.2.15.8/32\n10.2.15.9/32\n10.2.15.10/32\n10.2.15.11/32\n10.2.15.12/32\n10.2.15.13/32\n10.2.15.14/32\n10.2.15.15/32\n10.2.15.16/32\n10.2.15.17/32\n10.2.15.18/32\n10.2.15.19/32\n10.2.15.20/32\n10.2.15.21/32\n10.2.15.22/32\n10.2.15.23/32\n10.2.15.24/32\n10.2.15.25/32\n10.2.15.26/32\n10.2.15.27/32\n10.2.15.28/32\n10.2.15.29/32\n10.2.15.30/32\n10.2.15.31/32\n10.2.15.32/32\n10.2.15.33/32\n10.2.15.34/32\n10.2.15.35/32\n10.2.15.36/32\n10.2.15.37/32\n10.2.15.38/32\n10.2.15.39/32\n10.2.15.40/32\n10.2.15.41/32\n10.2.15.42/32\n10.2.15.43/32\n10.2.15.44/32\n10.2.15.45/32\n10.2.15.46/32\n10.2.15.47/32\n10.2.15.48/32\n10.2.15.49/32\n10.2.15.50/32\n10.2.15.51/32\n10.2.15.52/32\n10.2.15.53/32\n10.2.15.54/32\n10.2.15.55/32\n10.2.15.56/32\n10.2.15.57/32\n10.2.15.58/32\n10.2.15.59/32\n10.2.15.60/32\n10.2.15.61/32\n10.2.15.62/32\n10.2.15.63/32\n10.2.15.64/32\n10.2.15.65/32\n10.2.15.66/32\n10.2.15.67/32\n10.2.15.68/32\n10.2.15.69/32\n10.2.15.70/32\n10.2.15.71/32\n10.2.15.72/32\n10.2.15.73/32\n10.2.15.74/32\n10.2.15.75/32\n10.2.15.76/32\n10.2.15.77/32\n10.2.15.78/32\n10.2.15.79/32\n10.2.15.80/32\n10.2.15.81/32\n10.2.15.82/32\n10.2.15.83/32\n10.2.15.84/32\n10.2.15.85/32\n10.2.15.86/32\n10.2.15.87/32\n10.2.15.88/32\n10.2.15.89/32\n10.2.15.90/32\n10.2.15.91/32\n10.2.15.92/32\n10.2.15.93/32\n10.2.15.94/32\n10.2.15.95/32\n10.2.15.96/32\n10.2.15.97/32\n10.2.15.98/32\n10.2.15.99/32\n10.2.15.100/32\n10.2.15.101/32\n10.2.15.102/32\n10.2.15.103/32\n10.2.15.104/32\n10.2.15.105/32\n10.2.15.106/32\n10.2.15.107/32\n10.2.15.108/32\n10.2.15.109/32\n10.2.15.110/32\n10.2.15.111/32\n10.2.15.112/32\n10.2.15.113/32\n10.2.15.114/32\n10.2.15.115/32\n10.2.15.116/32\n10.2.15.117/32\n10.2.15.118/32\n10.2.15.119/32\n10.2.15.120/32\n10.2.15.121/32\n10.2.15.122/32\n10.2.15.123/32\n10.2.15.124/32\n10.2.15.125/32\n10.2.15.126/32\n10.2.15.127/32\n10.2.15.128/32\n10.2.15.129/32\n10.2.15.130/32\n10.2.15.131/32\n10.2.15.132/32\n10.2.15.133/32\n10.2.15.134/32\n10.2.15.135/32\n10.2.15.136/32\n10.2.15.137/32\n10.2.15.138/32\n10.2.15.139/32\n10.2.15.140/32\n10.2.15.141/32\n10.2.15.142/32\n10.2.15.143/32\n10.2.15.144/32\n10.2.15.145/32\n10.2.15.146/32\n10.2.15.147/32\n10.2.15.148/32\n10.2.15.149/32\n10.2.15.150/32\n10.2.15.151/32\n10.2.15.152/32\n10.2.15.153/32\n10.2.15.154/32\n10.2.15.155/32\n10.2.15.156/32\n10.2.15.157/32\n10.2.15.158/32\n10.2.15.159/32\n10.2.15.160/32\n10.2.15.161/32\n10.2.15.162/32\n10.2.15.163/32\n10.2.15.164/32\n10.2.15.165/32\n10.2.15.166/32\n10.2.15.167/32\n10.2.15.168/32\n10.2.15.169/32\n10.2.15.170/32\n10.2.15.171/32\n10.2.15.172/32\n10.2.15.173/32\n10.2.15.174/32\n10.2.15.175/32\n10.2.15.176/32\n10.2.15.177/32\n10.2.15.178/32\n10.2.15.179/32\n10.2.15.180/32\n10.2.15.181/32\n10.2.15.182/32\n10.2.15.183/32\n10.2.15.184/32\n10.2.15.185/32\n10.2.15.186/32\n10.2.15.187/32\n10.2.15.188/32\n10.2.15.189/32\n10.2.15.190/32\n10.2.15.191/32\n10.2.15.192/32\n10.2.15.193/32\n10.2.15.194/32\n10.2.15.195/32\n10.2.15.196/32\n10.2.15.197/32\n10.2.15.198/32\n10.2.15.199/32\n10.2.15.200/32\n10.2.15.201/32\n10.2.15.202/32\n10.2.15.203/32\n10.2.15.204/32\n10.2.15.205/32\n10.2.15.206/32\n10.2.15.207/32\n10.2.15.208/32\n10.2.15.209/32\n10.2.15.210/32\n10.2.15.211/32\n10.2.15.212/32\n10.2.15.213/32\n10.2.15.214/32\n10.2.15.215/32\n10.2.15.216/32\n10.2.15.217/32\n10.2.15.218/32\n10.2.15.219/32\n10.2.15.220/32\n10.2.15.221/32\n10.2.15.222/32\n10.2.15.223/32\n10.2.15.224/32\n10.2.15.225/32\n10.2.15.226/32\n10.2.15.227/32\n10.2.15.228/32\n10.2.15.229/32\n10.2.15.230/32\n10.2.15.231/32\n10.2.15.232/32\n10.2.15.233/32\n10.2.15.234/32\n10.2.15.235/32\n10.2.15.236/32\n10.2.15.237/32\n10.2.15.238/32\n10.2.15.239/32\n10.2.15.240/32\n10.2.15.241/32\n10.2.15.242/32\n10.2.15.243/32\n10.2.15.244/32\n10.2.15.245/32\n10.2.15.246/32\n10.2.15.247/32\n10.2.15.248/32\n10.2.15.249/32\n10.2.15.250/32\n10.2.15.251/32\n10.2.15.252/32\n10.2.15.253/32\n10.2.15.254/32\n", 'ipset format should match')
  end
end
